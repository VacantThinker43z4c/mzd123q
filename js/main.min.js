var defaultPath=null,isSutoSave=!0,fs=require("fs"),remote=require("electron").remote,electron=require("electron").electron,shell=require("electron").shell,globalShortcut=require("electron").globalShortcut,dialog=remote.dialog,app=remote.app,Menu=remote.Menu,MenuItem=remote.MenuItem,BrowserWindow=remote.BrowserWindow,ver=require("../version"),http=require("http"),path=require("path"),hotkeys=require("hotkeys-js"),log4js=require("log4js");log4js.configure({appenders:{NaoTuApp:{type:"dateFile",filename:getUserDataDir()+"/logs/naotu",pattern:".yyyy-MM-dd-hh.log",compress:!0,alwaysIncludePattern:!0}},categories:{default:{appenders:["NaoTuApp"],level:"debug"}}});var loadedLanguage,logger=log4js.getLogger("NaoTuApp"),confPath=path.join(getUserDataDir(),"/naotu.config.json");function setSavePath(){try{var e=getUserDataDir(),t=JSON.parse(fs.readFileSync(confPath));e=t.defSavePath,dialog.showOpenDialog({properties:["openDirectory"],defaultPath:e},function(e){e&&0<e.length&&(t.defSavePath=e[0],fs.writeFileSync(confPath,JSON.stringify(t)))})}catch(e){logger.error(e)}}function readFile(r){r&&(logger.info("打开文件 路径是："+r),defaultPath=r,fs.readFile(r,"utf8",function(e,t){logger.info("打开文件 内容是："+t);var n=JSON.parse(t);editor.minder.importJson(n),showFileName(r)}),saveRecords(defaultPath))}function writeFile(t,e,n){t&&(logger.info("保存文件 路径为："+t),logger.info("保存文件 内容是："+e),fs.writeFile(t,e,function(e){e?logger.error("An error ocurred creating the file "+e.message):showFileName(t)}),n||saveRecords(t))}function newDialog(){logger.info("新建文件"),hasData()?bootbox.confirm({message:i18n.__("sNewKm"),callback:function(e){e&&initRoot()}}):initRoot()}function hasData(){var e=editor.minder.getAllNode().length,t=editor.minder.getRoot().data.text;return 1!=e||t!=i18n.__("sMainTopic")}function initRoot(){defaultPath=null,getAppInstance().setTitle(i18n.__("sAppName")),editor.minder.importJson({root:{data:{text:i18n.__("sMainTopic")}},template:"filetree",theme:"fresh-blue"}),editor.minder.select(minder.getRoot(),!0)}function autoSave(e){isSutoSave=e.checked}function openDialog(){dialog.showOpenDialog({filters:[{name:"KityMinder",extensions:["km"]}]},function(e){e&&readFile(e[0])})}function openFileInFolder(){null!=defaultPath?shell.showItemInFolder(defaultPath):bootbox.alert(i18n.__("sNoOpenFile"))}function saveDialog(){defaultPath||(defaultPath=getDefaultPath());editor.minder.exportJson();var e=JSON.stringify(editor.minder.exportJson());writeFile(defaultPath,e)}function saveAsDialog(){var e=path.join(getUserDataDir(),"/"+minder.getRoot().data.text+".km");dialog.showSaveDialog({title:i18n.__("sSaveKm"),defaultPath:e,filters:[{name:"KityMinder",extensions:["km"]}]},function(e){if(e){defaultPath=e;editor.minder.exportJson();writeFile(e,JSON.stringify(editor.minder.exportJson()))}})}function exportDialog(){var e=path.join(getUserDataDir(),"/"+minder.getRoot().data.text),t=[],n=kityminder.data.getRegisterProtocol();for(var r in n)n.hasOwnProperty(r)&&n[r].encode&&t.push({name:n[r].fileDescription,extensions:[n[r].fileExtension.replace(".","")]});dialog.showSaveDialog({title:i18n.__("sExportKm"),defaultPath:e,filters:t},function(e){if(e){var t=e.toLowerCase().substring(e.lastIndexOf(".")),n=null,r=kityminder.data.getRegisterProtocol();for(var i in r)if(r.hasOwnProperty(i)&&r[i].encode&&r[i].fileExtension===t){n=r[i];break}exportFile(n,e)}})}function exitApp(){logger.info("exit successfully!"),app.quit()}function redo(){editor.history.redo()}function undo(){editor.history.undo()}function cut(){minder.execCommand("Cut")}function copy(){minder.execCommand("Copy")}function paste(){minder.execCommand("Paste")}function maxwin(){getAppInstance().maximize()}function minwin(){getAppInstance().minimize()}function license(){shell.openExternal("https://github.com/NaoTu/DesktopNaotu/blob/master/doc/Help.md")}function checkVersion(){logger.info("检查是否有新版本发布"),$.get("https://raw.githubusercontent.com/NaoTu/DesktopNaotu/master/version.js",function(e){e.substring(19,e.lastIndexOf(","))!=ver.version.slice(0,3).join(", ")?(bootbox.alert(i18n.__("sUpdateMessage")),shell.openExternal("https://github.com/NaoTu/DesktopNaotu/releases")):bootbox.alert(i18n.__("sNoUpdatesAvailable"))})}function about(){var e=["Copyright (c) 2018 Jack","版本： v"+ver.version.join("."),"QQ 讨论群：330722928"];dialog.showMessageBox({type:"info",title:i18n.__("sAppName"),message:e.join("\r"),buttons:["OK"]})}function exportFile(r,i){var e={download:!0,filename:i};minder.exportData(r.name,e).then(function(e){switch(r.dataType){case"text":writeFile(i,e,!0);break;case"base64":var t=e.replace(/^data:image\/\w+;base64,/,""),n=new Buffer(t,"base64");writeFile(i,n,!0)}return null})}function getDefaultPath(){try{var e=(new Date).format("yyyy-MM-dd_hhmmss"),t=JSON.parse(fs.readFileSync(confPath)).defSavePath||getUserDataDir();fs.exists(t,function(e){e||fs.mkdir(t)});var n=path.join(t,"/"+e+".km");return logger.info("getDefaultPath "+n),n}catch(e){logger.error(e)}}function getUserDataDir(){return(app||remote.app).getPath("userData")}function showFileName(e){if(null!=e){var t=e.lastIndexOf("/");-1<e.lastIndexOf("\\")&&(t=e.lastIndexOf("\\"));var n=e.substring(t+1)+" - "+i18n.__("sAppName");getAppInstance().setTitle(n)}}function getAppInstance(){return BrowserWindow.getAllWindows()[0]}function getDefConf(){return{locale:app.getLocale(),defSavePath:getUserDataDir(),recently:[]}}function getConf(){var e=JSON.parse(fs.readFileSync(confPath));return null==e&&(e=getDefConf(),fs.writeFileSync(confPath,JSON.stringify(e))),e}function clearRecently(){try{var e=getConf();e.recently=[],fs.writeFileSync(confPath,JSON.stringify(e)),updateMenus()}catch(e){logger.error(e)}}function saveRecords(e){for(var t=(new Date).format("yyyy-MM-dd hh:mm:ss"),n=getConf(),r=n.recently,i=[],o=null,a=0;a<r.length;a++){var l=r[a];l.path==e?o=l:i.push(l)}null==o?i.splice(0,0,{time:t,path:e}):(o.time=t,i.splice(0,0,o)),n.recently=i,fs.writeFileSync(confPath,JSON.stringify(n)),updateMenus()}function updateMenus(){for(var e=$.extend(!0,[],template),t=getConf().recently,n=0;n<Math.min(t.length,5);n++){var r=t[n];e[0].submenu[4].submenu.splice(e[0].submenu[4].submenu.length-2,0,{label:r.path,click:openRecently})}Menu.setApplicationMenu(Menu.buildFromTemplate(e))}function openRecently(e){var t=e.label;t&&fs.exists(t,function(e){e?readFile(t):bootbox.alert(i18n.__("sNoFileLocation"))})}$(function(){getAppInstance().setTitle(i18n.__("sAppName")),bootbox.setLocale("zh_CN"),logger.info("Jack welcomes you! v"+ver.version.slice(0,3).join("."));try{var e=path.join(getUserDataDir(),"/");fs.existsSync(e)||fs.mkdirSync(e),fs.exists(confPath,function(e){e||fs.writeFileSync(confPath,JSON.stringify(getDefConf()))})}catch(e){logger.error(e)}}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var n in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e};var i18n={lang:function(){var e="en";try{e=getConf().locale.replace("-","_")}catch(e){}return e},__:function(e){if(null==loadedLanguage){var t="locale";loadedLanguage=fs.existsSync(path.join(__dirname,t,i18n.lang()+".json"))?JSON.parse(fs.readFileSync(path.join(__dirname,t,i18n.lang()+".json"),"utf8")):JSON.parse(fs.readFileSync(path.join(__dirname,t,"en.json"),"utf8"))}var n=loadedLanguage[e];return void 0===n&&(n=e),n}};window.$=window.jQuery=require("./js/jquery.min.js"),angular.module("kityminderDemo",["kityminderEditor"]).config(function(e){e.set("lang",i18n.lang())}).controller("MainController",function(e,t){e.initEditor=function(e,t){window.editor=e,window.minder=t}}),window.$(function(){null!=minder&&(minder.on("contentchange",function(){isSutoSave&&saveDialog()}),minder.on("selectionchange",function(){var e=minder.getSelectedNode(),t=remote.Menu.getApplicationMenu();t.items[1].submenu.items[3].enabled=t.items[1].submenu.items[4].enabled=t.items[1].submenu.items[5].enabled=!!e}))});var template=[{label:i18n.__("mFile"),submenu:[{label:i18n.__("miNewFile"),accelerator:"CmdOrCtrl+N",click:newDialog},{label:i18n.__("miOpenFile"),accelerator:"CmdOrCtrl+O",click:openDialog},{type:"separator"},{label:i18n.__("miOpenFolder"),accelerator:"CmdOrCtrl+Shift+O",click:openFileInFolder},{label:i18n.__("miOpenRecent"),submenu:[{type:"separator"},{id:1,label:i18n.__("miClearRecent"),click:clearRecently}]},{type:"separator"},{label:i18n.__("miSave"),accelerator:"CmdOrCtrl+S",click:saveDialog},{label:i18n.__("miSaveAs"),accelerator:"CmdOrCtrl+Shift+S",click:saveAsDialog},{label:i18n.__("miExport"),accelerator:"CmdOrCtrl+E",click:exportDialog},{type:"separator"},{label:i18n.__("miAutoSave"),type:"checkbox",checked:!0,click:autoSave},{label:i18n.__("miSavePath"),accelerator:"CmdOrCtrl+R",click:setSavePath},{type:"separator"},{label:i18n.__("miExit"),click:exitApp}]},{label:i18n.__("mEdit"),submenu:[{label:i18n.__("miUndo"),accelerator:"CmdOrCtrl+Z",click:undo,selector:"undo:"},{label:i18n.__("miRedo"),accelerator:"CmdOrCtrl+Y",click:redo,selector:"redo:"},{type:"separator"},{label:i18n.__("miCut"),accelerator:"CmdOrCtrl+X",selector:"cut:",role:"cut"},{label:i18n.__("miCopy"),accelerator:"CmdOrCtrl+C",selector:"copy:",role:"copy"},{label:i18n.__("miPaste"),accelerator:"CmdOrCtrl+V",selector:"paste:",role:"paste"}]},{label:i18n.__("mWindow"),submenu:[{label:i18n.__("miMaxWin"),click:maxwin},{label:i18n.__("miMinWin"),click:minwin}]},{label:i18n.__("mHelp"),submenu:[{label:i18n.__("miShortcut"),accelerator:"CmdOrCtrl+/",click:shortcut},{type:"separator"},{label:i18n.__("miBackup"),click:license},{label:i18n.__("miCheckVer"),click:checkVersion},{type:"separator"},{label:i18n.__("miAbout"),click:about}]}],menu=Menu.buildFromTemplate(template);Menu.setApplicationMenu(menu);var body=document.body;function shortcut(){for(var e=[{groupName:"节点操作",groupItem:[{key:"Enter",desc:" 插入兄弟节点"},{key:"Tab, Insert",desc:" 插入子节点"},{key:"Shift + Tab",desc:" 插入父节点"},{key:"Delete",desc:" 删除节点"},{key:"Up, Down, Left, Right",desc:" 节点导航"},{key:"Alt + Up, Down",desc:" 向上/向下调整顺序"},{key:"/",desc:" 展开/收起节点"},{key:"F2",desc:" 编辑节点"},{key:"Shift + Enter",desc:" 文本换行"},{key:"Ctrl + A",desc:" 全选节点"},{key:"Ctrl + C",desc:" 复制节点"},{key:"Ctrl + X",desc:" 剪切节点"},{key:"Ctrl + V",desc:" 粘贴节点"},{key:"Ctrl + B",desc:" 加粗"},{key:"Ctrl + I",desc:" 斜体"},{key:"Ctrl + F",desc:" 查找节点"}]},{groupName:"视野控制",groupItem:[{key:"Alt + 拖动, 右键拖动",desc:" 拖动视野"},{key:"滚轮, 触摸板",desc:" 移动视野"},{key:"空白处双击, Ctrl + Enter",desc:" 居中根节点"},{key:"Ctrl + +, -",desc:" 放大/缩小视野"}]},{groupName:"文件操作",groupItem:[{key:"Ctrl + O",desc:" 打开"},{key:"Ctrl + S",desc:" 保存"},{key:"Ctrl + Shift + S",desc:" 另存为"}]},{groupName:"布局",groupItem:[{key:"Ctrl + Shift + L",desc:" 整理布局"}]},{groupName:"后悔药",groupItem:[{key:"Ctrl + Z",desc:" 撤销"},{key:"Ctrl + Y",desc:" 重做"}]}],t="",n=0;n<e.length;n++){var r=e[n];t+="\n"+r.groupName+"\n";for(var i=0;i<r.groupItem.length;i++){var o=r.groupItem[i];t+="       "+o.desc+"   "+o.key+"\n"}}dialog.showMessageBox({type:"none",title:"快捷键",message:t,buttons:["OK"]})}body.ondrop=function(e){e.preventDefault();var t=e.dataTransfer.files[0];return t.name.toLowerCase().endsWith(".km")?readFile(t.path):bootbox.alert(i18n.__("sLoadedError")),!1},body.ondragover=body.ondragleave=body.ondragend=function(){return!1},kityminder.data.registerProtocol("freemind",function(e){var l={"full-1":["priority",1],"full-2":["priority",2],"full-3":["priority",3],"full-4":["priority",4],"full-5":["priority",5],"full-6":["priority",6],"full-7":["priority",7],"full-8":["priority",8]};function r(e){var t={};return function e(t,n){var r;if(n.data={text:t.TEXT},t.icon){var i,o=t.icon;if(o.length&&0<o.length)for(r in o)(i=l[o[r].BUILTIN])&&(n.data[i[0]]=i[1]);else(i=l[o.BUILTIN])&&(n.data[i[0]]=i[1])}if(t.LINK&&(n.data.hyperlink=t.LINK),t.node){var a=t.node;if(a.length&&0<a.length)for(r in n.children=[],a)n.children.push({}),e(a[r],n.children[r]);else n.children=[{}],e(a,n.children[0])}}($.xml2json(e).node,t),t}return{fileDescription:"Freemind 格式",fileExtension:".mm",dataType:"text",decode:function(n){return new Promise(function(e,t){try{e(r(n))}catch(e){t(new Error("XML 文件损坏！"))}})},encode:function(e,t,n){return'<map version="1.0.1">\n\x3c!-- To view this file, download free mind mapping software FreeMind from http://freemind.sourceforge.net --\x3e\n'+function e(t){var n=t.data;var r=[["CREATED",n.created],["ID",n.id],["MODIFIED",n.created],["MODIFIED",n.created],["TEXT",n.text],["POSITION",n.position]];return"<node"+i(r)+">\n"+(t.children?t.children.map(e).join("\n"):"")+(n.priority?'<icon BUILTIN="full-'+n.priority+'"/>\n':"")+(n.image?'<richcontent TYPE="NODE"><html><head></head><body>\n<img'+i([["src",n.image],["width",n.imageSize.width],["height",n.imageSize.height]])+"/>\n</body></html></richcontent>\n":"")+"</node>\n"}(e.root)+"</map>\n";function i(e){return e.map(function(e){return e[1]?" "+e[0]+'="'+e[1]+'"':""}).join("")}}}}()),kityminder.data.registerProtocol("mindmanager",function(e){var a={"urn:mindjet:Prio1":["PriorityIcon",1],"urn:mindjet:Prio2":["PriorityIcon",2],"urn:mindjet:Prio3":["PriorityIcon",3],"urn:mindjet:Prio4":["PriorityIcon",4],"urn:mindjet:Prio5":["PriorityIcon",5],0:["ProgressIcon",1],25:["ProgressIcon",2],50:["ProgressIcon",3],75:["ProgressIcon",4],100:["ProgressIcon",5]};function o(e){var t={};return function e(t,n){var r;n.data={text:t.Text&&t.Text.PlainText||""},t.Task&&(t.Task.TaskPriority&&(r=a[t.Task.TaskPriority])&&(n.data[r[0]]=r[1]),t.Task.TaskPercentage&&(r=a[t.Task.TaskPercentage])&&(n.data[r[0]]=r[1]));if(t.Hyperlink&&(n.data.hyperlink=t.Hyperlink.Url),t.SubTopics&&t.SubTopics.Topic){var i=t.SubTopics.Topic;if(i.length&&0<i.length)for(var o in n.children=[],i)n.children.push({}),e(i[o],n.children[o]);else n.children=[{}],e(i,n.children[0])}}($.xml2json(e).OneTopic.Topic,t),t}function t(i){return new Promise(function(t,e){for(var n,r;(n=i.pop())&&"Document.xml"!=n.filename.split("/").pop();)n=null;n?n.getData(new zip.TextWriter,function(e){r=o($.parseXML(e)),t(r)}):e(new Error("Main document missing"))})}return{fileDescription:"MindManager 格式",fileExtension:".mmap",dataType:"blob",decode:function(e){return(n=e,new Promise(function(t,e){zip.createReader(new zip.BlobReader(n),function(e){e.getEntries(t)},e)})).then(t);var n},encode:null,recognizePriority:-1}}());